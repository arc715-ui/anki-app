{
  "name": "Telegram Botï¼ˆPhase Dï¼‰",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 30
            }
          ]
        }
      },
      "name": "30ç§’ã”ã¨ãƒãƒ¼ãƒªãƒ³ã‚°",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [220, 300],
      "id": "schedule-polling"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://cgnrttgyjtjjzwkygvas.supabase.co/rest/v1/telegram_bot_state?id=eq.1&select=last_update_id",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}" },
            { "name": "Authorization", "value": "=Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}" }
          ]
        },
        "options": {}
      },
      "name": "ã‚ªãƒ•ã‚»ãƒƒãƒˆå–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 300],
      "id": "get-offset"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_BOT_TOKEN }}/getUpdates?offset={{ $json.last_update_id + 1 }}&timeout=0&allowed_updates=[\"message\",\"callback_query\"]",
        "options": {}
      },
      "name": "Telegramæ›´æ–°å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [660, 300],
      "id": "get-updates"
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "const response = $input.first().json;\nconst updates = response.result || [];\n\nif (updates.length === 0) return [];\n\nconst chatId = $env.TELEGRAM_CHAT_ID;\nconst items = [];\nlet maxUpdateId = 0;\n\nfor (const update of updates) {\n  if (update.update_id > maxUpdateId) maxUpdateId = update.update_id;\n\n  if (update.callback_query) {\n    const cb = update.callback_query;\n    if (String(cb.message?.chat?.id) !== String(chatId)) continue;\n    items.push({\n      json: {\n        route: 'callback',\n        callbackData: cb.data,\n        callbackQueryId: cb.id,\n        chatId: cb.message.chat.id,\n        messageId: cb.message.message_id,\n        maxUpdateId\n      }\n    });\n    continue;\n  }\n\n  const msg = update.message;\n  if (!msg || String(msg.chat?.id) !== String(chatId)) continue;\n  const text = (msg.text || '').trim();\n\n  if (text === '/start' || text === '/menu') {\n    items.push({\n      json: { route: 'command', command: text, chatId: msg.chat.id, maxUpdateId }\n    });\n  } else if (text.length > 0) {\n    items.push({\n      json: { route: 'study_record', text, chatId: msg.chat.id, maxUpdateId }\n    });\n  }\n}\n\nif (items.length === 0) {\n  return [{ json: { route: '_skip', maxUpdateId } }];\n}\n\nfor (const item of items) {\n  item.json.maxUpdateId = maxUpdateId;\n}\nreturn items;"
      },
      "name": "ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 300],
      "id": "routing"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.maxUpdateId }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "name": "æ›´æ–°ã‚ã‚Šï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1100, 500],
      "id": "if-has-updates"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://cgnrttgyjtjjzwkygvas.supabase.co/rest/v1/telegram_bot_state?id=eq.1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}" },
            { "name": "Authorization", "value": "=Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}" },
            { "name": "Content-Type", "value": "application/json" },
            { "name": "Prefer", "value": "return=minimal" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ last_update_id: $json.maxUpdateId, updated_at: new Date().toISOString() }) }}",
        "options": {}
      },
      "name": "ã‚ªãƒ•ã‚»ãƒƒãƒˆæ›´æ–°",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1320, 500],
      "id": "update-offset"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.route }}",
              "value2": "command"
            }
          ]
        }
      },
      "name": "ã‚³ãƒãƒ³ãƒ‰ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1100, 300],
      "id": "if-command"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.route }}",
              "value2": "callback"
            }
          ]
        }
      },
      "name": "ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1320, 350],
      "id": "if-callback"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.route }}",
              "value2": "study_record"
            }
          ]
        }
      },
      "name": "è¨˜éŒ²ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1540, 400],
      "id": "if-study-record"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const chatId = $json.chatId;\nconst text = 'ğŸ“‹ *ãƒ¡ãƒ‹ãƒ¥ãƒ¼* \\u2014 æ“ä½œã‚’é¸ã‚“ã§ãã ã•ã„';\nconst keyboard = {\n  inline_keyboard: [\n    [\n      { text: 'ğŸ“Š ä»Šæ—¥ã®é€²æ—', callback_data: 'progress' },\n      { text: 'ğŸ¯ æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³', callback_data: 'milestone' }\n    ],\n    [\n      { text: 'ğŸ“ è¨˜éŒ²ã™ã‚‹', callback_data: 'record' }\n    ]\n  ]\n};\n\nreturn {\n  json: {\n    chatId,\n    text,\n    reply_markup: JSON.stringify(keyboard)\n  }\n};"
      },
      "name": "ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹ç¯‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1320, 100],
      "id": "build-menu"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_BOT_TOKEN }}/sendMessage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ chat_id: $json.chatId, text: $json.text, parse_mode: 'Markdown', reply_markup: $json.reply_markup }) }}",
        "options": {}
      },
      "name": "ãƒ¡ãƒ‹ãƒ¥ãƒ¼é€ä¿¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, 100],
      "id": "send-menu"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.callbackData }}",
              "value2": "progress"
            }
          ]
        }
      },
      "name": "é€²æ—ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1540, 250],
      "id": "if-progress"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.callbackData }}",
              "value2": "milestone"
            }
          ]
        }
      },
      "name": "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ï¼Ÿ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1760, 350],
      "id": "if-milestone"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://cgnrttgyjtjjzwkygvas.supabase.co/rest/v1/daily_study_summary?user_id=eq.{{ $env.ANKI_USER_ID }}&days_left=gt.0&order=days_left.asc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}" },
            { "name": "Authorization", "value": "=Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}" }
          ]
        },
        "options": {}
      },
      "name": "é€²æ—ãƒ‡ãƒ¼ã‚¿å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1760, 150],
      "id": "fetch-progress",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "const rows = $input.all().map(i => i.json);\nconst cbItem = $('é€²æ—ï¼Ÿ').first().json;\nconst chatId = cbItem.chatId;\nconst messageId = cbItem.messageId;\n\nconst icons = {\n  'ç¤¾åŠ´å£«': 'ğŸ”´', 'è¡Œæ”¿æ›¸å£«': 'ğŸŸ¡', 'è¨ºæ–­å£«': 'ğŸŸ ',\n  'ä¸­å°ä¼æ¥­è¨ºæ–­å£«': 'ğŸŸ ', 'åŠ´è¡›ã‚³ãƒ³': 'ğŸ”µ', 'åŠ´åƒè¡›ç”Ÿã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ': 'ğŸ”µ'\n};\n\nif (rows.length === 0 || (rows.length === 1 && !rows[0].exam_name)) {\n  return [{ json: { chatId, messageId, text: 'ğŸ“Š ä»Šæ—¥ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚' } }];\n}\n\nlet lines = [];\nlet totalStudied = 0;\nlet totalQuota = 0;\n\nfor (const r of rows) {\n  const icon = icons[r.short_name] || icons[r.exam_name] || 'âšª';\n  const studied = r.studied_today || 0;\n  const quota = r.daily_quota || 0;\n  const pct = quota > 0 ? Math.round(studied / quota * 100) : 0;\n  const correctRate = studied > 0 ? Math.round((r.correct_today || 0) / studied * 100) : 0;\n  totalStudied += studied;\n  totalQuota += quota;\n\n  const bar = 'â–ˆ'.repeat(Math.floor(pct / 10)) + 'â–‘'.repeat(10 - Math.floor(pct / 10));\n  lines.push(`${icon} ${r.short_name || r.exam_name}ï¼ˆæ®‹${r.days_left}æ—¥ï¼‰\\n  ${bar} ${pct}%  ${studied}/${quota}å•  æ­£ç­”ç‡${correctRate}%`);\n}\n\nconst overallPct = totalQuota > 0 ? Math.round(totalStudied / totalQuota * 100) : 0;\nlet text = `ğŸ“Š ä»Šæ—¥ã®é€²æ—\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n${lines.join('\\n\\n')}\\n\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”\\né”æˆç‡: ${overallPct}% (${totalStudied}/${totalQuota}å•)`;\n\nreturn [{ json: { chatId, messageId, text } }];"
      },
      "name": "é€²æ—æ•´å½¢",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1980, 150],
      "id": "format-progress"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_BOT_TOKEN }}/editMessageText",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ chat_id: $json.chatId, message_id: $json.messageId, text: $json.text }) }}",
        "options": {}
      },
      "name": "é€²æ—è¡¨ç¤º",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2200, 150],
      "id": "show-progress"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://cgnrttgyjtjjzwkygvas.supabase.co/rest/v1/milestones?user_id=eq.{{ $env.ANKI_USER_ID }}&status=eq.upcoming&target_date=gte.{{ new Date().toISOString().split('T')[0] }}&order=target_date.asc&limit=8",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}" },
            { "name": "Authorization", "value": "=Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}" }
          ]
        },
        "options": {}
      },
      "name": "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1980, 280],
      "id": "fetch-milestones",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "const rows = $input.all().map(i => i.json);\nconst cbItem = $('ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ï¼Ÿ').first().json;\nconst chatId = cbItem.chatId;\nconst messageId = cbItem.messageId;\n\nif (rows.length === 0 || (rows.length === 1 && !rows[0].title)) {\n  return [{ json: { chatId, messageId, text: 'ğŸ¯ ä»Šå¾Œã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' } }];\n}\n\nconst icons = {\n  'ç¤¾ä¼šä¿é™ºåŠ´å‹™å£«': 'ğŸ”´', 'è¡Œæ”¿æ›¸å£«': 'ğŸŸ¡',\n  'ä¸­å°ä¼æ¥­è¨ºæ–­å£«1æ¬¡': 'ğŸŸ ', 'åŠ´åƒè¡›ç”Ÿã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ': 'ğŸ”µ'\n};\n\nconst today = new Date();\ntoday.setHours(0, 0, 0, 0);\n\nlet lines = [];\nfor (const m of rows) {\n  const icon = icons[m.exam_name] || 'âšª';\n  const target = new Date(m.target_date);\n  const daysLeft = Math.ceil((target - today) / (1000 * 60 * 60 * 24));\n  const dateStr = `${target.getMonth() + 1}/${target.getDate()}`;\n  const scoreStr = m.target_score ? ` ç›®æ¨™:${m.target_score}%` : '';\n  lines.push(`${icon} ${dateStr}ï¼ˆæ®‹${daysLeft}æ—¥ï¼‰${scoreStr}\\n  ${m.title}`);\n}\n\nlet text = `ğŸ¯ æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n${lines.join('\\n\\n')}`;\n\nreturn [{ json: { chatId, messageId, text } }];"
      },
      "name": "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ•´å½¢",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2200, 280],
      "id": "format-milestones"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_BOT_TOKEN }}/editMessageText",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ chat_id: $json.chatId, message_id: $json.messageId, text: $json.text }) }}",
        "options": {}
      },
      "name": "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤º",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2420, 280],
      "id": "show-milestones"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_BOT_TOKEN }}/editMessageText",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ chat_id: $json.chatId, message_id: $json.messageId, text: 'ğŸ“ è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\nå­¦ç¿’çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚\\n\\nä¾‹:\\nãƒ»ç¤¾åŠ´å£« åŠ´åŸº 10å•ä¸­8å•æ­£è§£\\nãƒ»è¡Œæ”¿æ›¸å£« æ°‘æ³• 20å•ä¸­15å•\\nãƒ»è¨ºæ–­å£« è²¡å‹™ 30å•25å•æ­£è§£\\n\\nè©¦é¨“å + ç§‘ç›® + å•é¡Œæ•° + æ­£è§£æ•°\\nã®å½¢å¼ã§é€ã£ã¦ãã ã•ã„ã€‚' }) }}",
        "options": {}
      },
      "name": "è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰æ¡ˆå†…",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1980, 420],
      "id": "record-guide"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "x-api-key", "value": "={{ $env.CLAUDE_API_KEY }}" },
            { "name": "anthropic-version", "value": "2023-06-01" },
            { "name": "content-type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'claude-haiku-4-5-20251001', max_tokens: 256, system: 'ã‚ãªãŸã¯å­¦ç¿’è¨˜éŒ²ã®è§£æã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰è©¦é¨“åãƒ»ç§‘ç›®ãƒ»å•é¡Œæ•°ãƒ»æ­£è§£æ•°ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚\\n\\nå¯¾å¿œã™ã‚‹è©¦é¨“:\\n- ç¤¾åŠ´å£«/ã‚·ãƒ£ãƒ­ã‚¦ã‚·/ç¤¾ä¿ â†’ exam_name:\"ç¤¾ä¼šä¿é™ºåŠ´å‹™å£«\", short_name:\"ç¤¾åŠ´å£«\"\\n- è¡Œæ”¿æ›¸å£«/ã‚®ãƒ§ã‚¦ã‚»ã‚¤ â†’ exam_name:\"è¡Œæ”¿æ›¸å£«\", short_name:\"è¡Œæ”¿æ›¸å£«\"\\n- è¨ºæ–­å£«/ã‚·ãƒ³ãƒ€ãƒ³ã‚·/ä¸­å° â†’ exam_name:\"ä¸­å°ä¼æ¥­è¨ºæ–­å£«1æ¬¡\", short_name:\"è¨ºæ–­å£«1æ¬¡\"\\n- åŠ´è¡›ã‚³ãƒ³/ãƒ­ã‚¦ã‚¨ã‚¤/åŠ´è¡› â†’ exam_name:\"åŠ´åƒè¡›ç”Ÿã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ\", short_name:\"åŠ´è¡›ã‚³ãƒ³\"\\n\\nJSONå½¢å¼ã®ã¿ã§è¿”ç­”ã—ã¦ãã ã•ã„ã€‚ä»–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚\\næˆåŠŸ: {\"success\":true,\"exam_name\":\"...\",\"short_name\":\"...\",\"subject\":\"...\",\"total\":N,\"correct\":N}\\nè§£æä¸å¯: {\"success\":false,\"error\":\"ç†ç”±\"}', messages: [{ role: 'user', content: $json.text }] }) }}",
        "options": {}
      },
      "name": "Claudeè§£æ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1760, 550],
      "id": "claude-parse"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const response = $json;\nconst rawText = response.content?.[0]?.text || '';\nconst chatId = $('è¨˜éŒ²ï¼Ÿ').first().json.chatId;\nconst originalText = $('è¨˜éŒ²ï¼Ÿ').first().json.text;\n\ntry {\n  const jsonMatch = rawText.match(/```(?:json)?\\s*([\\s\\S]*?)```/) ||\n                    rawText.match(/(\\{[\\s\\S]*?\\})/);\n  const jsonStr = jsonMatch ? jsonMatch[1].trim() : rawText.trim();\n  const parsed = JSON.parse(jsonStr);\n\n  if (!parsed.success) {\n    return { json: { valid: false, chatId, error: parsed.error || 'è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ' } };\n  }\n\n  const total = parseInt(parsed.total);\n  const correct = parseInt(parsed.correct);\n\n  if (isNaN(total) || isNaN(correct) || total <= 0 || correct < 0 || correct > total) {\n    return { json: { valid: false, chatId, error: 'å•é¡Œæ•°ãƒ»æ­£è§£æ•°ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' } };\n  }\n\n  return {\n    json: {\n      valid: true,\n      chatId,\n      exam_name: parsed.exam_name,\n      short_name: parsed.short_name,\n      subject: parsed.subject || null,\n      total_questions: total,\n      correct_count: correct,\n      raw_message: originalText\n    }\n  };\n} catch (e) {\n  return { json: { valid: false, chatId, error: 'å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ' } };\n}"
      },
      "name": "è§£æãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1980, 550],
      "id": "validate-parse"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.valid }}",
              "value2": true
            }
          ]
        }
      },
      "name": "è§£æçµæœåˆ†å²",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2200, 550],
      "id": "if-valid"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://cgnrttgyjtjjzwkygvas.supabase.co/rest/v1/telegram_study_logs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{ $env.SUPABASE_SERVICE_ROLE_KEY }}" },
            { "name": "Authorization", "value": "=Bearer {{ $env.SUPABASE_SERVICE_ROLE_KEY }}" },
            { "name": "Content-Type", "value": "application/json" },
            { "name": "Prefer", "value": "return=minimal" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ user_id: $env.ANKI_USER_ID, exam_name: $json.exam_name, short_name: $json.short_name, subject: $json.subject, total_questions: $json.total_questions, correct_count: $json.correct_count, raw_message: $json.raw_message }) }}",
        "options": {}
      },
      "name": "è¨˜éŒ²ä¿å­˜",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2420, 480],
      "id": "save-record"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_BOT_TOKEN }}/sendMessage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ chat_id: $('è§£æçµæœåˆ†å²').first().json.chatId, text: 'âœ… è¨˜éŒ²ã—ã¾ã—ãŸï¼\\n' + (() => { const icons = { 'ç¤¾åŠ´å£«': 'ğŸ”´', 'è¡Œæ”¿æ›¸å£«': 'ğŸŸ¡', 'è¨ºæ–­å£«1æ¬¡': 'ğŸŸ ', 'åŠ´è¡›ã‚³ãƒ³': 'ğŸ”µ' }; const d = $('è§£æçµæœåˆ†å²').first().json; const icon = icons[d.short_name] || 'âšª'; const pct = Math.round(d.correct_count / d.total_questions * 100); return icon + ' ' + d.short_name + (d.subject ? ' / ' + d.subject : '') + '\\nğŸ“Š ' + pct + '% (' + d.correct_count + '/' + d.total_questions + 'å•)'; })() }) }}",
        "options": {}
      },
      "name": "ç¢ºèªé€ä¿¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2640, 480],
      "id": "send-confirm"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_BOT_TOKEN }}/sendMessage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ chat_id: $json.chatId, text: 'âŒ è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\\nğŸ“ ä¾‹: ç¤¾åŠ´å£« åŠ´åŸº 10å•ä¸­8å•æ­£è§£' }) }}",
        "options": {}
      },
      "name": "ã‚¨ãƒ©ãƒ¼é€ä¿¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2420, 650],
      "id": "send-error"
    }
  ],
  "connections": {
    "30ç§’ã”ã¨ãƒãƒ¼ãƒªãƒ³ã‚°": {
      "main": [[{ "node": "ã‚ªãƒ•ã‚»ãƒƒãƒˆå–å¾—", "type": "main", "index": 0 }]]
    },
    "ã‚ªãƒ•ã‚»ãƒƒãƒˆå–å¾—": {
      "main": [[{ "node": "Telegramæ›´æ–°å–å¾—", "type": "main", "index": 0 }]]
    },
    "Telegramæ›´æ–°å–å¾—": {
      "main": [[{ "node": "ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°", "type": "main", "index": 0 }]]
    },
    "ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°": {
      "main": [[
        { "node": "ã‚³ãƒãƒ³ãƒ‰ï¼Ÿ", "type": "main", "index": 0 },
        { "node": "æ›´æ–°ã‚ã‚Šï¼Ÿ", "type": "main", "index": 0 }
      ]]
    },
    "æ›´æ–°ã‚ã‚Šï¼Ÿ": {
      "main": [
        [{ "node": "ã‚ªãƒ•ã‚»ãƒƒãƒˆæ›´æ–°", "type": "main", "index": 0 }],
        []
      ]
    },
    "ã‚³ãƒãƒ³ãƒ‰ï¼Ÿ": {
      "main": [
        [{ "node": "ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹ç¯‰", "type": "main", "index": 0 }],
        [{ "node": "ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼Ÿ", "type": "main", "index": 0 }]
      ]
    },
    "ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼Ÿ": {
      "main": [
        [{ "node": "é€²æ—ï¼Ÿ", "type": "main", "index": 0 }],
        [{ "node": "è¨˜éŒ²ï¼Ÿ", "type": "main", "index": 0 }]
      ]
    },
    "è¨˜éŒ²ï¼Ÿ": {
      "main": [
        [{ "node": "Claudeè§£æ", "type": "main", "index": 0 }],
        []
      ]
    },
    "ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹ç¯‰": {
      "main": [[{ "node": "ãƒ¡ãƒ‹ãƒ¥ãƒ¼é€ä¿¡", "type": "main", "index": 0 }]]
    },
    "é€²æ—ï¼Ÿ": {
      "main": [
        [{ "node": "é€²æ—ãƒ‡ãƒ¼ã‚¿å–å¾—", "type": "main", "index": 0 }],
        [{ "node": "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ï¼Ÿ", "type": "main", "index": 0 }]
      ]
    },
    "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ï¼Ÿ": {
      "main": [
        [{ "node": "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å–å¾—", "type": "main", "index": 0 }],
        [{ "node": "è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰æ¡ˆå†…", "type": "main", "index": 0 }]
      ]
    },
    "é€²æ—ãƒ‡ãƒ¼ã‚¿å–å¾—": {
      "main": [[{ "node": "é€²æ—æ•´å½¢", "type": "main", "index": 0 }]]
    },
    "é€²æ—æ•´å½¢": {
      "main": [[{ "node": "é€²æ—è¡¨ç¤º", "type": "main", "index": 0 }]]
    },
    "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å–å¾—": {
      "main": [[{ "node": "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ•´å½¢", "type": "main", "index": 0 }]]
    },
    "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ•´å½¢": {
      "main": [[{ "node": "ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤º", "type": "main", "index": 0 }]]
    },
    "Claudeè§£æ": {
      "main": [[{ "node": "è§£æãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³", "type": "main", "index": 0 }]]
    },
    "è§£æãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³": {
      "main": [[{ "node": "è§£æçµæœåˆ†å²", "type": "main", "index": 0 }]]
    },
    "è§£æçµæœåˆ†å²": {
      "main": [
        [{ "node": "è¨˜éŒ²ä¿å­˜", "type": "main", "index": 0 }],
        [{ "node": "ã‚¨ãƒ©ãƒ¼é€ä¿¡", "type": "main", "index": 0 }]
      ]
    },
    "è¨˜éŒ²ä¿å­˜": {
      "main": [[{ "node": "ç¢ºèªé€ä¿¡", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    { "name": "æš—è¨˜ã‚«ãƒ¼ãƒ‰" },
    { "name": "Phase D" }
  ]
}
